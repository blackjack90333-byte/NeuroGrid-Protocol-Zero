<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Био Распад</title>
    <style>
        body {
            background-color: #0f0f13; /* Очень темный, почти черный */
            color: #ef4444; /* Кроваво-красный */
            margin: 0;
            padding: 15px;
            font-family: 'Segoe UI', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
            overflow: hidden;
            position: relative;
        }

        /* Эффект старого монитора / помех */
        body::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        .container {
            text-align: center;
            z-index: 1;
            width: 100%;
        }

        .label {
            font-size: 10px;
            letter-spacing: 3px;
            color: #7f1d1d; /* Темно-красный */
            text-transform: uppercase;
            margin-bottom: 10px;
            font-weight: 800;
            animation: flicker 4s infinite;
        }

        /* ГИГАНТСКИЙ СЧЕТЧИК */
        .counter {
            font-family: 'Courier New', monospace;
            font-size: 38px;
            font-weight: 900;
            letter-spacing: -1px;
            text-shadow: 0 0 15px rgba(239, 68, 68, 0.6);
            margin: 5px 0;
        }

        .unit {
            font-size: 12px;
            opacity: 0.5;
            font-weight: normal;
        }

        .sub-text {
            font-size: 9px;
            color: #555;
            font-family: monospace;
            margin-top: 5px;
        }

        /* --- ЛИНИЯ ЭКГ (СЕРДЦЕБИЕНИЕ) --- */
        .ekg-container {
            width: 100%;
            height: 40px;
            margin-top: 20px;
            position: relative;
            overflow: hidden;
            border-top: 1px solid #333;
            border-bottom: 1px solid #333;
        }

        .ekg-line {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(239, 68, 68, 0.2);
            transform: translateY(-50%);
        }

        /* Бегущая точка пульса */
        .ekg-dot {
            width: 4px;
            height: 4px;
            background: #ef4444;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            box-shadow: 0 0 10px #ef4444;
            /* Анимация под 72 BPM */
            animation: ekgMove 2.5s linear infinite; 
        }

        /* Всплеск на линии (имитация удара) */
        .ekg-dot::after {
            content: '';
            position: absolute;
            top: -15px;
            left: -2px;
            width: 2px;
            height: 30px;
            background: #ef4444;
            opacity: 0;
            animation: ekgBeat 0.833s ease-in-out infinite; 
        }

        @keyframes ekgMove {
            0% { left: 0%; }
            100% { left: 100%; }
        }

        @keyframes ekgBeat {
            0% { opacity: 0; height: 2px; top: 0; }
            10% { opacity: 1; height: 30px; top: -15px; } /* УДАР */
            20% { opacity: 0; height: 2px; top: 0; }
            100% { opacity: 0; }
        }

        @keyframes flicker {
            0%, 19%, 21%, 23%, 25%, 54%, 56%, 100% { opacity: 1; }
            20%, 24%, 55% { opacity: 0.4; }
        }

    </style>
</head>
<body>

    <div class="container">
        <div class="label">ОСТАЛОСЬ УДАРОВ СЕРДЦА</div>
        
        <div class="counter" id="beat-display">
            ЗАГРУЗКА...
        </div>
        
        <div class="sub-text" id="debug-info">РИТМ: 72 УД/МИН // СИНХРОНИЗАЦИЯ...</div>

        <div class="ekg-container">
            <div class="ekg-line"></div>
            <div class="ekg-dot"></div>
        </div>
    </div>

    <script>
        // --- КОНСТАНТА ---
        const BPM = 72; 

        // --- ЛОГИКА ---
        function parseCustomDate(dateStr) {
            if (!dateStr) return null;
            const [datePart, timePart] = dateStr.split(' ');
            if (!datePart) return null; // время может отсутствовать
            const [day, month, year] = datePart.split('.');
            // Время ставим по нулям, если его нет
            let hours = 0, minutes = 0, seconds = 0;
            if (timePart) {
                [hours, minutes, seconds] = timePart.split(':');
            }
            return new Date(year, month - 1, day, hours, minutes, seconds);
        }

        function updateBeats() {
            const rawData = localStorage.getItem('hud_settings');
            
            // Если данных нет, ничего не считаем
            if (!rawData) return;

            try {
                const settings = JSON.parse(rawData);
                
                // 1. Получаем дату рождения
                const birthStr = settings.birthdate; 
                // 2. Получаем срок жизни из таблицы (число, например 30)
                const deathAge = parseInt(settings.death_date);

                const birthDate = parseCustomDate(birthStr);

                if (!birthDate || isNaN(deathAge)) {
                    document.getElementById('beat-display').innerText = "ОШИБКА ДАННЫХ";
                    return;
                }

                // 3. Вычисляем дату смерти (Рождение + deathAge лет)
                const targetDate = new Date(birthDate);
                targetDate.setFullYear(birthDate.getFullYear() + deathAge);

                const now = new Date();

                // 4. Считаем оставшееся время в миллисекундах
                const msLeft = targetDate - now;

                if (msLeft <= 0) {
                    document.getElementById('beat-display').innerText = "СИСТЕМНЫЙ СБОЙ";
                    document.getElementById('debug-info').innerText = "ВРЕМЯ ИСТЕКЛО";
                    return;
                }

                // 5. Переводим миллисекунды в минуты
                const minutesLeft = msLeft / (1000 * 60);

                // 6. Считаем удары (Минуты * BPM)
                const beatsLeft = minutesLeft * BPM;

                // 7. Обновляем экран
                // Используем 'ru-RU' для красивых пробелов между тысячами (1 234 567)
                document.getElementById('beat-display').innerText = Math.floor(beatsLeft).toLocaleString('ru-RU');
                document.getElementById('debug-info').innerText = `РИТМ: ${BPM} УД/МИН // ЦЕЛЬ: ${deathAge} ЛЕТ`;

            } catch (e) {
                console.error(e);
            }
        }

        // Обновляем быстро для анимации цифр
        setInterval(updateBeats, 50); 
        updateBeats();

    </script>
</body>
</html>